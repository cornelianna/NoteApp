@model NoteApp.Models.Post
@using System.Security.Claims

<div class="post">
    <!-- Left side: Image or Note -->
    <div class="left-content">
        @if (!string.IsNullOrEmpty(Model.ImageUrl))
        {
            <!-- If an image exists, display the image -->
            <div class="contentImg">
                <img src="@Model.ImageUrl" alt="Post image">
            </div>
        }
        else
        {
            <!-- If no image, display the note content here -->
            <div class="noteContent">
                <p>@Model.Content</p>
            </div>
        }
    </div>

    <!-- Dropdown for post actions -->
    <div class="dropdown">
        <!-- Toggle for the dropdown menu -->
        <img class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" src="~/images/more.svg" alt="More" />

        <!-- Dropdown menu -->
        <ul class="dropdown-menu">
            @if (Model.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
            {
                <!-- User is the owner -->
                <!-- Edit option -->
                <li>
                    <a class="dropdown-item d-flex align-items-center" href="@Url.Action("UpdatePost", new { id = Model.Id })">
                        <img class="p-1 me-2" src="~/images/edit.svg" alt="Edit" style="width: 20px; height: 20px;" />
                        Edit
                    </a>
                </li>
                <!-- Delete option -->
                <li>
                    <form asp-action="DeletePost" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this post?');">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="dropdown-item text-danger d-flex align-items-center">
                            <img class="p-1 me-2" src="~/images/delete.svg" alt="Delete" style="width: 20px; height: 20px;" />
                            Delete Post
                        </button>
                    </form>
                </li>
                <!-- Do not show 'Report' option to the owner -->
            }
            else
            {
                <!-- User is not the owner -->
                <!-- Report option -->
                <li>
                    <a class="dropdown-item text-danger d-flex align-items-center" href="#">
                        <img class="p-1 me-2" src="~/images/report.svg" alt="Report" style="width: 20px; height: 20px;" />
                        Report
                    </a>
                </li>
            }
        </ul>
    </div>

    <!-- Right side: Post Details and Comments -->
    <div class="right-content">
        <!-- Post Details Box (always present) -->
        <div class="post-details-box">
            <!-- Post header -->
            <div class="post-header">
                <div class="userImg">
                    <img src="~/images/icon.svg" alt="Avatar">
                </div>
                <div class="post-info">
                    <span class="username">@Model.Username</span>
                    <span class="post-date">@Model.CreatedAt.ToString("g")</span>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <!-- Note content under header when there is an image -->
                <div class="noteContentWithImage">
                    <p>@Model.Content</p>
                </div>
            }
        </div>

        <!-- Comments section -->
        <h5 class="comments-header">Comments</h5>
        <div class="discussions">
            <div class="comments-scrollable">
                @foreach (var comment in Model.Comments)
                {
                    @Html.Partial("_CommentPartial.cshtml", comment)
                }
            </div>
        </div>

        <!-- Comment form -->
        <form asp-action="AddComment" method="post" class="comment-form mt-3">
            <input type="hidden" name="postId" value="@Model.Id" />
            <textarea class="form-control" name="Content" placeholder="Add a comment" required></textarea>
            <input class="btn btn-primary mt-2" type="submit" value="Comment" />
        </form>
    </div>
</div>
@section Scripts {
    <script>
        (function() {
            var form = document.getElementById('commentForm-@Model.Id');
            var commentsContainer = document.getElementById('commentsContainer-@Model.Id');

            form.addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent default form submission

                var formData = new FormData(form);
                var postId = '@Model.Id';

                fetch('@Url.Action("AddComment", "Post")', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin' // Include cookies for CSRF protection
                })
                .then(function (response) {
                    if (response.ok) {
                        return response.text();
                    } else {
                        return response.text().then(function (text) {
                            throw new Error(text);
                        });
                    }
                })
                .then(function (html) {
                    // Update the comments section with the new comment
                    commentsContainer.innerHTML = html;

                    // Clear the textarea
                    form.querySelector('textarea[name="Content"]').value = '';
                })
                .catch(function (error) {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('An error occurred while adding your comment.');
                });
            });
        })();
    </script>
}
